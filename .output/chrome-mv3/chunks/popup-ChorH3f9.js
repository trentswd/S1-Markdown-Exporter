(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))g(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const p of l.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&g(p)}).observe(document,{childList:!0,subtree:!0});function b(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function g(n){if(n.ep)return;n.ep=!0;const l=b(n);fetch(n.href,l)}})();try{}catch(r){console.error("[wxt] Failed to initialize plugins",r)}const k=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,v=k;document.addEventListener("DOMContentLoaded",()=>{const r=document.getElementById("exportButton"),t=document.getElementById("status"),b=document.getElementById("startFloor"),g=document.getElementById("endFloor"),n=document.getElementById("postsPerPage"),l=document.getElementById("downloadImages"),p=document.getElementById("postsPerFile"),y=document.getElementById("startFile"),h=document.getElementById("endFile");let i=null,f=null;function C(e){if(!e){console.log("No saved settings found, using defaults.");return}console.log("Loading saved settings:",e),b.value=e.startFloor?.toString()??"",g.value=e.endFloor?.toString()??"",n.value=e.postsPerPage?.toString()??"40",l.checked=e.downloadImages??!0;const s=document.querySelector(`input[name="linkFormat"][value="${e.linkFormat??"obsidian"}"]`);s&&(s.checked=!0);const o=document.querySelector(`input[name="emoteFormat"][value="${e.emoteFormat??"obsidian"}"]`);o&&(o.checked=!0),p.value=e.postsPerFile?.toString()??"",y.value=e.startFile?.toString()??"",h.value=e.endFile?.toString()??""}function w(){const e=b.value,s=g.value,o=n.value,a=l.checked,N=document.querySelector('input[name="linkFormat"]:checked'),E=document.querySelector('input[name="emoteFormat"]:checked'),T=N?.value??"obsidian",B=E?.value??"obsidian",S=p.value,P=y.value,x=h.value;let u=e?parseInt(e,10):null,c=s?parseInt(s,10):null,I=o?parseInt(o,10):40,F=S?parseInt(S,10):null,d=P?parseInt(P,10):null,m=x?parseInt(x,10):null;return u!==null&&isNaN(u)&&(u=null),c!==null&&isNaN(c)&&(c=null),u!==null&&u<1&&(u=1),c!==null&&c<1&&(c=null),(isNaN(I)||I<1)&&(I=40),F!==null&&(isNaN(F)||F<1)&&(F=null),d!==null&&(isNaN(d)||d<1)&&(d=null),m!==null&&(isNaN(m)||m<1)&&(m=null),u!==null&&c!==null&&u>c?(t.textContent="错误：起始楼层不能大于结束楼层！",null):d!==null&&m!==null&&d>m?(t.textContent="错误：起始文件页不能大于结束文件页！",null):{startFloor:u,endFloor:c,postsPerPage:I,downloadImages:a,linkFormat:T,emoteFormat:B,postsPerFile:F,startFile:d,endFile:m}}v.tabs.query({active:!0,currentWindow:!0}).then(async e=>{if(e.length===0){t.textContent="错误：找不到活动标签页。",r.disabled=!0;return}i=e[0];const s=i.id;if(i.url&&(i.url.includes("stage1st.com/2b/thread-")||i.url.includes("stage1st.com/2b/forum.php")||i.url.includes("bbs.saraba1st.com/2b/thread-")||i.url.includes("bbs.saraba1st.com/2b/forum.php"))&&s){r.disabled=!0,t.textContent="正在加载设置...";try{const a=await v.tabs.sendMessage(s,{type:"getTidAndSettings"});a&&a.tid?(f=a.tid,console.log(`[Popup] Received TID: ${f}`),a.settings?(C(a.settings),t.textContent="已加载本帖设置。"):t.textContent="准备就绪 (无本帖设置)。",r.disabled=!1):(t.textContent="无法获取TID，将使用默认设置。",console.warn("Could not get TID from content script.",a?.error),r.disabled=!1)}catch(a){t.textContent="错误：脚本未注入。请刷新S1页面后重试。",console.error(a.message)}}else t.textContent="请在 S1 帖子页面使用。",r.disabled=!0}),r.addEventListener("click",()=>{if(!i||!i.id)return;const e=w();if(e===null)return;const s=i.id;f?(console.log(`[Popup] Sending save request for tid ${f}...`),v.tabs.sendMessage(s,{type:"saveSettings",tid:f,options:e}).then(o=>{o?.status==="saved"?console.log("[Popup] Content script confirmed settings saved."):console.warn("[Popup] Content script reported error saving settings:",o?.error)}).catch(o=>{console.error("Save settings message failed:",o.message)})):console.warn("[Popup] No currentTid, settings will not be saved."),console.log("Sending export options:",e),r.disabled=!0,r.textContent="处理中...",t.textContent="已发送命令，请查看网页...",v.tabs.sendMessage(s,{type:"startExport",options:e}).then(o=>{o&&o.status==="started"?(t.textContent="导出已开始！",setTimeout(()=>window.close(),1e3)):o&&o.status==="already_running"?(t.textContent="导出已在运行中...",setTimeout(()=>window.close(),1e3)):(t.textContent="未知响应。",r.textContent="开始导出",r.disabled=!1)}).catch(o=>{t.textContent="错误：脚本未注入。请刷新S1页面后重试。",console.error(o.message),r.textContent="开始导出",r.disabled=!1})})});
