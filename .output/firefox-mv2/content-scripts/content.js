var content=(function(){"use strict";function st(e){return e}const q=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function Ae(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])}return e}function J(e,t){return Array(t+1).join(e)}function le(e){return e.replace(/^\n*/,"")}function ce(e){for(var t=e.length;t>0&&e[t-1]===`
`;)t--;return e.substring(0,t)}function ue(e){return ce(le(e))}var Ie=["ADDRESS","ARTICLE","ASIDE","AUDIO","BLOCKQUOTE","BODY","CANVAS","CENTER","DD","DIR","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","FRAMESET","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","HTML","ISINDEX","LI","MAIN","MENU","NAV","NOFRAMES","NOSCRIPT","OL","OUTPUT","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"];function Z(e){return ee(e,Ie)}var de=["AREA","BASE","BR","COL","COMMAND","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR"];function fe(e){return ee(e,de)}function xe(e){return he(e,de)}var ge=["A","TABLE","THEAD","TBODY","TFOOT","TH","TD","IFRAME","SCRIPT","AUDIO","VIDEO"];function Te(e){return ee(e,ge)}function Pe(e){return he(e,ge)}function ee(e,t){return t.indexOf(e.nodeName)>=0}function he(e,t){return e.getElementsByTagName&&t.some(function(n){return e.getElementsByTagName(n).length})}var N={};N.paragraph={filter:"p",replacement:function(e){return`

`+e+`

`}},N.lineBreak={filter:"br",replacement:function(e,t,n){return n.br+`
`}},N.heading={filter:["h1","h2","h3","h4","h5","h6"],replacement:function(e,t,n){var r=Number(t.nodeName.charAt(1));if(n.headingStyle==="setext"&&r<3){var l=J(r===1?"=":"-",e.length);return`

`+e+`
`+l+`

`}else return`

`+J("#",r)+" "+e+`

`}},N.blockquote={filter:"blockquote",replacement:function(e){return e=ue(e).replace(/^/gm,"> "),`

`+e+`

`}},N.list={filter:["ul","ol"],replacement:function(e,t){var n=t.parentNode;return n.nodeName==="LI"&&n.lastElementChild===t?`
`+e:`

`+e+`

`}},N.listItem={filter:"li",replacement:function(e,t,n){var r=n.bulletListMarker+"   ",l=t.parentNode;if(l.nodeName==="OL"){var g=l.getAttribute("start"),k=Array.prototype.indexOf.call(l.children,t);r=(g?Number(g)+k:k+1)+".  "}var L=/\n$/.test(e);return e=ue(e)+(L?`
`:""),e=e.replace(/\n/gm,`
`+" ".repeat(r.length)),r+e+(t.nextSibling?`
`:"")}},N.indentedCodeBlock={filter:function(e,t){return t.codeBlockStyle==="indented"&&e.nodeName==="PRE"&&e.firstChild&&e.firstChild.nodeName==="CODE"},replacement:function(e,t,n){return`

    `+t.firstChild.textContent.replace(/\n/g,`
    `)+`

`}},N.fencedCodeBlock={filter:function(e,t){return t.codeBlockStyle==="fenced"&&e.nodeName==="PRE"&&e.firstChild&&e.firstChild.nodeName==="CODE"},replacement:function(e,t,n){for(var r=t.firstChild.getAttribute("class")||"",l=(r.match(/language-(\S+)/)||[null,""])[1],g=t.firstChild.textContent,k=n.fence.charAt(0),L=3,A=new RegExp("^"+k+"{3,}","gm"),R;R=A.exec(g);)R[0].length>=L&&(L=R[0].length+1);var O=J(k,L);return`

`+O+l+`
`+g.replace(/\n$/,"")+`
`+O+`

`}},N.horizontalRule={filter:"hr",replacement:function(e,t,n){return`

`+n.hr+`

`}},N.inlineLink={filter:function(e,t){return t.linkStyle==="inlined"&&e.nodeName==="A"&&e.getAttribute("href")},replacement:function(e,t){var n=t.getAttribute("href");n&&(n=n.replace(/([()])/g,"\\$1"));var r=z(t.getAttribute("title"));return r&&(r=' "'+r.replace(/"/g,'\\"')+'"'),"["+e+"]("+n+r+")"}},N.referenceLink={filter:function(e,t){return t.linkStyle==="referenced"&&e.nodeName==="A"&&e.getAttribute("href")},replacement:function(e,t,n){var r=t.getAttribute("href"),l=z(t.getAttribute("title"));l&&(l=' "'+l+'"');var g,k;switch(n.linkReferenceStyle){case"collapsed":g="["+e+"][]",k="["+e+"]: "+r+l;break;case"shortcut":g="["+e+"]",k="["+e+"]: "+r+l;break;default:var L=this.references.length+1;g="["+e+"]["+L+"]",k="["+L+"]: "+r+l}return this.references.push(k),g},references:[],append:function(e){var t="";return this.references.length&&(t=`

`+this.references.join(`
`)+`

`,this.references=[]),t}},N.emphasis={filter:["em","i"],replacement:function(e,t,n){return e.trim()?n.emDelimiter+e+n.emDelimiter:""}},N.strong={filter:["strong","b"],replacement:function(e,t,n){return e.trim()?n.strongDelimiter+e+n.strongDelimiter:""}},N.code={filter:function(e){var t=e.previousSibling||e.nextSibling,n=e.parentNode.nodeName==="PRE"&&!t;return e.nodeName==="CODE"&&!n},replacement:function(e){if(!e)return"";e=e.replace(/\r?\n|\r/g," ");for(var t=/^`|^ .*?[^ ].* $|`$/.test(e)?" ":"",n="`",r=e.match(/`+/gm)||[];r.indexOf(n)!==-1;)n=n+"`";return n+t+e+t+n}},N.image={filter:"img",replacement:function(e,t){var n=z(t.getAttribute("alt")),r=t.getAttribute("src")||"",l=z(t.getAttribute("title")),g=l?' "'+l+'"':"";return r?"!["+n+"]("+r+g+")":""}};function z(e){return e?e.replace(/(\n+\s*)+/g,`
`):""}function pe(e){this.options=e,this._keep=[],this._remove=[],this.blankRule={replacement:e.blankReplacement},this.keepReplacement=e.keepReplacement,this.defaultRule={replacement:e.defaultReplacement},this.array=[];for(var t in e.rules)this.array.push(e.rules[t])}pe.prototype={add:function(e,t){this.array.unshift(t)},keep:function(e){this._keep.unshift({filter:e,replacement:this.keepReplacement})},remove:function(e){this._remove.unshift({filter:e,replacement:function(){return""}})},forNode:function(e){if(e.isBlank)return this.blankRule;var t;return(t=te(this.array,e,this.options))||(t=te(this._keep,e,this.options))||(t=te(this._remove,e,this.options))?t:this.defaultRule},forEach:function(e){for(var t=0;t<this.array.length;t++)e(this.array[t],t)}};function te(e,t,n){for(var r=0;r<e.length;r++){var l=e[r];if(ke(l,t,n))return l}}function ke(e,t,n){var r=e.filter;if(typeof r=="string"){if(r===t.nodeName.toLowerCase())return!0}else if(Array.isArray(r)){if(r.indexOf(t.nodeName.toLowerCase())>-1)return!0}else if(typeof r=="function"){if(r.call(e,t,n))return!0}else throw new TypeError("`filter` needs to be a string, array, or function")}function Ne(e){var t=e.element,n=e.isBlock,r=e.isVoid,l=e.isPre||function(B){return B.nodeName==="PRE"};if(!(!t.firstChild||l(t))){for(var g=null,k=!1,L=null,A=me(L,t,l);A!==t;){if(A.nodeType===3||A.nodeType===4){var R=A.data.replace(/[ \r\n\t]+/g," ");if((!g||/ $/.test(g.data))&&!k&&R[0]===" "&&(R=R.substr(1)),!R){A=ne(A);continue}A.data=R,g=A}else if(A.nodeType===1)n(A)||A.nodeName==="BR"?(g&&(g.data=g.data.replace(/ $/,"")),g=null,k=!1):r(A)||l(A)?(g=null,k=!0):g&&(k=!1);else{A=ne(A);continue}var O=me(L,A,l);L=A,A=O}g&&(g.data=g.data.replace(/ $/,""),g.data||ne(g))}}function ne(e){var t=e.nextSibling||e.parentNode;return e.parentNode.removeChild(e),t}function me(e,t,n){return e&&e.parentNode===t||n(t)?t.nextSibling||t.parentNode:t.firstChild||t.nextSibling||t.parentNode}var re=typeof window<"u"?window:{};function Ce(){var e=re.DOMParser,t=!1;try{new e().parseFromString("","text/html")&&(t=!0)}catch{}return t}function Re(){var e=function(){};return De()?e.prototype.parseFromString=function(t){var n=new window.ActiveXObject("htmlfile");return n.designMode="on",n.open(),n.write(t),n.close(),n}:e.prototype.parseFromString=function(t){var n=document.implementation.createHTMLDocument("");return n.open(),n.write(t),n.close(),n},e}function De(){var e=!1;try{document.implementation.createHTMLDocument("").open()}catch{re.ActiveXObject&&(e=!0)}return e}var Le=Ce()?re.DOMParser:Re();function Me(e,t){var n;if(typeof e=="string"){var r=Fe().parseFromString('<x-turndown id="turndown-root">'+e+"</x-turndown>","text/html");n=r.getElementById("turndown-root")}else n=e.cloneNode(!0);return Ne({element:n,isBlock:Z,isVoid:fe,isPre:t.preformattedCode?qe:null}),n}var oe;function Fe(){return oe=oe||new Le,oe}function qe(e){return e.nodeName==="PRE"||e.nodeName==="CODE"}function Oe(e,t){return e.isBlock=Z(e),e.isCode=e.nodeName==="CODE"||e.parentNode.isCode,e.isBlank=Be(e),e.flankingWhitespace=_e(e,t),e}function Be(e){return!fe(e)&&!Te(e)&&/^\s*$/i.test(e.textContent)&&!xe(e)&&!Pe(e)}function _e(e,t){if(e.isBlock||t.preformattedCode&&e.isCode)return{leading:"",trailing:""};var n=Ue(e.textContent);return n.leadingAscii&&we("left",e,t)&&(n.leading=n.leadingNonAscii),n.trailingAscii&&we("right",e,t)&&(n.trailing=n.trailingNonAscii),{leading:n.leading,trailing:n.trailing}}function Ue(e){var t=e.match(/^(([ \t\r\n]*)(\s*))(?:(?=\S)[\s\S]*\S)?((\s*?)([ \t\r\n]*))$/);return{leading:t[1],leadingAscii:t[2],leadingNonAscii:t[3],trailing:t[4],trailingNonAscii:t[5],trailingAscii:t[6]}}function we(e,t,n){var r,l,g;return e==="left"?(r=t.previousSibling,l=/ $/):(r=t.nextSibling,l=/^ /),r&&(r.nodeType===3?g=l.test(r.nodeValue):n.preformattedCode&&r.nodeName==="CODE"?g=!1:r.nodeType===1&&!Z(r)&&(g=l.test(r.textContent))),g}var He=Array.prototype.reduce,We=[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^-/g,"\\-"],[/^\+ /g,"\\+ "],[/^(=+)/g,"\\$1"],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/\[/g,"\\["],[/\]/g,"\\]"],[/^>/g,"\\>"],[/_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]];function K(e){if(!(this instanceof K))return new K(e);var t={rules:N,headingStyle:"setext",hr:"* * *",bulletListMarker:"*",codeBlockStyle:"indented",fence:"```",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",br:"  ",preformattedCode:!1,blankReplacement:function(n,r){return r.isBlock?`

`:""},keepReplacement:function(n,r){return r.isBlock?`

`+r.outerHTML+`

`:r.outerHTML},defaultReplacement:function(n,r){return r.isBlock?`

`+n+`

`:n}};this.options=Ae({},t,e),this.rules=new pe(this.options)}K.prototype={turndown:function(e){if(!je(e))throw new TypeError(e+" is not a string, or an element/document/fragment node.");if(e==="")return"";var t=ve.call(this,new Me(e,this.options));return Ve.call(this,t)},use:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)this.use(e[t]);else if(typeof e=="function")e(this);else throw new TypeError("plugin must be a Function or an Array of Functions");return this},addRule:function(e,t){return this.rules.add(e,t),this},keep:function(e){return this.rules.keep(e),this},remove:function(e){return this.rules.remove(e),this},escape:function(e){return We.reduce(function(t,n){return t.replace(n[0],n[1])},e)}};function ve(e){var t=this;return He.call(e.childNodes,function(n,r){r=new Oe(r,t.options);var l="";return r.nodeType===3?l=r.isCode?r.nodeValue:t.escape(r.nodeValue):r.nodeType===1&&(l=Ge.call(t,r)),Ee(n,l)},"")}function Ve(e){var t=this;return this.rules.forEach(function(n){typeof n.append=="function"&&(e=Ee(e,n.append(t.options)))}),e.replace(/^[\t\r\n]+/,"").replace(/[\t\r\n\s]+$/,"")}function Ge(e){var t=this.rules.forNode(e),n=ve.call(this,e),r=e.flankingWhitespace;return(r.leading||r.trailing)&&(n=n.trim()),r.leading+t.replacement(n,e,this.options)+r.trailing}function Ee(e,t){var n=ce(e),r=le(t),l=Math.max(e.length-n.length,t.length-r.length),g=`

`.substring(0,l);return n+g+r}function je(e){return e!=null&&(typeof e=="string"||e.nodeType&&(e.nodeType===1||e.nodeType===9||e.nodeType===11))}const ze={matches:["https://*.stage1st.com/2b/thread-*","https://*.stage1st.com/2b/forum.php*tid=*","https://*.bbs.saraba1st.com/2b/thread-*","https://*.bbs.saraba1st.com/2b/forum.php*tid=*"],runAt:"document_idle",main(){window.s1ExportRunning=!1;const e="https://app.stage1st.com/2b/api/app",t="s1_app_sid",n=new K({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-"});let r=null;function l(s,o=!1){r||(r=document.createElement("div"),r.id="s1-exporter-status",r.style.position="fixed",r.style.top="20px",r.style.right="20px",r.style.padding="15px 20px",r.style.background="#333",r.style.color="white",r.style.zIndex="99999",r.style.borderRadius="5px",r.style.fontSize="16px",r.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',document.body.appendChild(r)),r.textContent=s,r.style.background=o?"#d9534f":"#007aff"}function g(){r&&(r.remove(),r=null)}class k{queue;filenamesInZip;failedDownloads;linkFormat;downloadEnabled;tid;constructor(o){this.queue=new Map,this.filenamesInZip=new Set,this.failedDownloads=[],this.linkFormat="obsidian",this.downloadEnabled=!0,this.tid=o||"unknown_tid"}setDownloadEnabled(o){this.downloadEnabled=!!o,console.log(`[ImageDownloader] Image downloading ${this.downloadEnabled?"ENABLED":"DISABLED"}.`)}setLinkFormat(o){o==="standard"||o==="obsidian"?(this.linkFormat=o,console.log(`[ImageDownloader] Link format set to: ${this.linkFormat}`)):(console.warn(`[ImageDownloader] Invalid link format specified: ${o}. Using default 'obsidian'.`),this.linkFormat="obsidian")}getUniqueFilename(o,a){let i,u;const c=o.lastIndexOf(".");c===-1||c===0?(i=o,u=".png"):(i=o.substring(0,c),u=o.substring(c)),i=i.replace(/[:*?"<>|]/g,"_");const f=`${this.tid}/${a}/`;let h=i+u,p=1;for(;this.filenamesInZip.has(f+h);)h=`${i}-${p}${u}`,p++;const x=f+h;return this.filenamesInZip.add(x),x}enqueue(o,a="image",i){if(!o||!o.startsWith("http"))return`![${a}](${o})`;if(!this.downloadEnabled)return`![${a.replace(/\]/g,"\\]")}](${o})`;const u=i?.dataset.s1Page||"unknown_page";if(this.queue.has(o)){const h=this.queue.get(o);return this.linkFormat==="standard"?`![${a}](${encodeURI(h)})`:`![[${h}]]`}let c;try{let h=new URL(o).pathname.split("/").pop();c=decodeURIComponent(h.split("?")[0]),(!c||c.trim()==="")&&(c=a)}catch{c=a}const f=this.getUniqueFilename(c,u);return this.queue.set(o,f),W(`S1 Exporter: 入队图片， ${o}, ${a}, ${f}`),this.linkFormat==="standard"?`![${a}](${encodeURI(f)})`:`![[${f}]]`}async processQueue(o){const a=this.queue.size;if(a===0){o(0,0,"没有需要下载的图片。");return}W(`S1 Exporter: 开始下载 ${a} 张图片 (保存至 '下载' 文件夹下的子目录)...`,"blue");let i=0;this.failedDownloads=[];for(const[u,c]of this.queue.entries()){i++,o(i,a,c);try{const f=await q.runtime.sendMessage({type:"downloadImage",url:u,savePath:c});if(!f||!f.success)throw new Error(f?.error||"下载任务创建失败 (无详细信息)");await new Promise(h=>setTimeout(h,50))}catch(f){W(`❌ 图片下载失败: ${u} (目标路径: ${c}) - 错误: ${f.message}`,"red"),this.failedDownloads.push({url:u,savePath:c,error:f.message})}}W(`S1 Exporter: 图片队列处理完毕。${this.failedDownloads.length} 个失败。`,"blue")}}function L(s){const o=s?.username??"",a=s?.password??"",i=s?.msg??"";return`
         <div id="login-dialog" style="width: 400px; height: 260px; position: fixed; top: 50%; left: 50%; margin-left: -200px; margin-top: -130px; z-index: 9999; background: #F6F7EB; border: 3px solid #CCCC99; padding-left: 20px; padding-right: 20px;">
             <div style="width: 100%; padding-top: 20px">通过s1官方app接口查看不可见内容，需要单独登录<span style="float: right; cursor: pointer; font-weight: bold;" class="flbc" id="login-close">X</span></div>
             <div style="width: 100%; padding-top: 20px"><input type="text" id="username" value="${o}" placeholder="用户名" style="width: 95%;"></div>
             <div style="width: 100%; padding-top: 20px"><input type="password" id="password" value="${a}" placeholder="密码" style="width: 95%;"></div>
             <div style="width: 100%; padding-top: 20px">
                 <select id="questionId" style="width: 100%;">
                     <option value="0">安全提问(未设置请忽略)</option>
                     <option value="1">母亲的名字</option>
                     <option value="2">爷爷的名字</option>
                     <option value="3">父亲出生的城市</option>
                     <option value="4">您其中一位老师的名字</option>
                     <option value="5">您个人计算机的型号</option>
                     <option value="6">您最喜欢的餐馆名称</option>
                     <option value="7">驾驶执照最后四位数字</option>
                 </select>
             </div>
             <div id="answer-row" style="display: none;">
                 <div style="width: 100%; padding-top: 20px"><input type="text" id="answer" placeholder="答案" style="width: 95%;"></div>
             </div>
             <div style="width: 100%; padding-top: 20px"><button id="login-confirm">确定</button></div>
             <div style="width: 100%; padding-top: 10px; color: red; height: 20px;">${i}</div>
         </div>`}function A(s){const o=s?.pid??"unknown",a=s?.message??"[内容为空]";return`
         <div class="t_fsz">
             <table cellspacing="0" cellpadding="0">
                 <tbody>
                     <tr>
                         <td class="t_f" id="postmessage_${o}">
                             ${a}
                         </td>
                     </tr>
                 </tbody>
             </table>
         </div>`}let R=null,O=null,B=null;async function Xe(s){window.s1ExportRunning=!0,l("准备中...");try{if(O=await be(),!O)throw window.s1ExportRunning=!1,new Error("无法获取帖子 TID");let o=new k(O);if(o.setLinkFormat(s.linkFormat),o.setDownloadEnabled(s.downloadImages),n.addRule("s1AttachmentImage",{filter:d=>!!(d.nodeName==="IMG"&&(d.hasAttribute("aid")||d.getAttribute("src")?.endsWith("/none.gif")&&(d.hasAttribute("zoomfile")||d.hasAttribute("file")))),replacement:(d,w)=>{let v="";const y=w,E=y.getAttribute("zoomfile"),b=y.getAttribute("file"),S=y.getAttribute("src"),U=y.getAttribute("aid")||"未知ID";E&&E.startsWith("http")?v=E:b&&b.startsWith("http")?v=b:S&&!S.endsWith("/none.gif")&&S.startsWith("http")?v=S:b&&b.startsWith("data/attachment")?v=`${location.origin}/2b/${b}`:S&&S.startsWith("data/attachment")&&(v=`${location.origin}/2b/${S}`);let G=y.getAttribute("alt")||`附件 ${U}`;return(G.toLowerCase()==="attachimg"||G.trim()==="")&&(G=`附件 ${U}`),v?(console.log(`[Turndown Rule: s1AttachmentImage] Enqueueing: ${v}`),o.enqueue(v,G,y)):(console.warn("[Turndown Rule: s1AttachmentImage] 未能找到附件图片的有效 URL:",y.outerHTML),`[附件图片 aid=${U} 加载失败]`)}}),n.addRule("externalImage",{filter:d=>!!(d.nodeName==="IMG"&&d.getAttribute("src")&&d.getAttribute("src").startsWith("http")&&!d.hasAttribute("aid")&&!d.getAttribute("src").includes("/smiley/")),replacement:(d,w)=>{const v=w,y=v.getAttribute("src"),E=v.getAttribute("alt")||"ext_image";return console.log(`[Turndown Rule: externalImage] Enqueueing: ${y}`),o.enqueue(y,E,v)}}),n.addRule("s1SmileyObsidian",{filter:d=>!!(d.nodeName==="IMG"&&d.hasAttribute("smilieid")&&d.getAttribute("src").includes("/smiley/")),replacement:(d,w)=>{const v=w,y=v.getAttribute("src"),E=v.getAttribute("smilieid");if(s.emoteFormat==="standard")return`![${E||"smiley"}](${y})`;let b=`表情${E||""}`;const S=y.match(/\/smiley\/(.+)$/);S&&S[1]&&(b=S[1]);let U=`![[${b}`;return E&&(U+=`|smilieid=${E}`),U+="]]",U}}),n.addRule("s1Quote",{filter:d=>!!(d.nodeName==="BLOCKQUOTE"&&d.querySelector("div.quote > font")),replacement:(d,w)=>{const v=w.querySelector("div.quote > font");let y="用户";v&&(y=v.innerText.replace(/\s+/g," ").trim());const E=w.cloneNode(!0);E.querySelector("div.quote")?.remove();const b=n.turndown(E);return`> **引用 ${y}:**
>
`+b.split(`
`).map(S=>`> ${S}`).join(`
`)+`

`}}),n.addRule("s1SimpleQuote",{filter:d=>d.nodeName==="BLOCKQUOTE"&&!d.querySelector("div.quote > font"),replacement:d=>{const w=d.trim();return w.startsWith("本帖最后由")&&!w.includes(`
`)?`> *${w}*

`:`
> `+w.replace(/\n/g,`
> `)+`

`}}),R=(await q.storage.local.get(t))[t]||null,R)console.log("S1 Exporter: 使用已存储的 App SID.");else{if(console.log("S1 Exporter: 未找到 App SID, 需要登录."),l("需要登录..."),!await Se())throw new Error("登录取消或失败");R=(await q.storage.local.get(t))[t],console.log("S1 Exporter: 登录成功.")}const i=document.getElementById("thread_subject"),u=document.querySelector('link[rel="canonical"]'),c=document.querySelectorAll('#pt .z a[href^="forum-"]'),f=c.length>0?c[c.length-1]:null,h=i?i.innerText.trim():"未知标题",p=u?u.href:location.href,x=f?f.innerText.trim():"未知版块",{postsPerFile:$,startFile:M,endFile:_}=s;let m=s.startFloor||1,I=s.endFloor||null,T=m,F=I;if($){const d=M||1,w=_||null;T=m+(d-1)*$;let v=null;if(w){const y=w-d+1;if(y>0){const E=y*$;v=T+E-1}}I!==null&&v!==null?F=Math.min(I,v):F=I||v}I!==null&&T>I&&(console.warn(`[MainExport] 计算出的起始楼层 (${T}) 大于结束楼层 (${I}). 导出将为空.`),T=I+1),console.log("[MainExport] 选项:",s),console.log(`[MainExport] 计算出的有效范围: Floors ${T||"1"} to ${F||"End"}`),l("加载页面...");const{allPostElements:D,actualStartPage:P,actualEndPage:C}=await Je(s.postsPerPage,T,F),V=P!==null?`(S1页: ${P}-${C})`:"";l(`正在解析 ${V}...`);const{header:H,posts:j}=ot(h,p,x,D,T,F,n);if(await o.processQueue((d,w,v)=>{l(`下载图片 ${d}/${w}...`)}),$===null||$<=0){l("正在生成 Markdown...");const d=H+j.map(w=>`

---

## ${w.floor} | ${w.author} | ${w.time}

${w.mdContent.trim()}${w.rateContent}`).join("");ye(h,d)}else{const d=it(j,$),w=s.startFile||1;l(`正在生成 ${d.length} 个文件...`);for(let v=0;v<d.length;v++){const y=w+v,E=d[v],b=H+E.map(S=>`

---

## ${S.floor} | ${S.author} | ${S.time}

${S.mdContent.trim()}${S.rateContent}`).join("");ye(`${h} - Page ${y}`,b),await new Promise(S=>setTimeout(S,100))}}o.failedDownloads.length>0?(l(`导出完成，${o.failedDownloads.length}张图片失败！`,!0),alert(`导出完成，但有 ${o.failedDownloads.length} 张图片下载失败，请检查控制台（F12）获取详情。`),console.warn("S1 Exporter: 以下图片下载失败:",o.failedDownloads),setTimeout(g,5e3)):(l("导出成功！"),setTimeout(g,3e3))}catch(o){console.error("S1 Markdown 导出失败:",o),l(`导出失败: ${o.message}`,!0),o.message&&(o.message.includes("登录失效")||o.message.includes("LOGIN_INVALID"))&&(await q.storage.local.remove(t),l("导出失败 (需重新登录)",!0)),setTimeout(g,5e3)}finally{window.s1ExportRunning=!1}}async function Je(s,o,a){const i=[];let u=null,c=null;const f=document.querySelector("#pgt .pg strong"),h=document.querySelector('#pgt .pg span[title^="共"]');let p=1,x=1;if(h){const m=h.innerText.match(/\/ (\d+) 页/);m&&(p=parseInt(m[1],10))}f&&(x=parseInt(f.innerText,10));const $=document.getElementById("postlist");if(!$)throw new Error("无法找到 #postlist 元素");console.log(`S1 Exporter: 总 ${p} 页, 当前 ${x} 页. 请求楼层 ${o??"1"}-${a??"End"}, 每页 ${s}.`);let M=1,_=p;o!==null||a!==null?(o!==null&&(M=Math.max(1,Math.floor((o-1)/s)+1)),a!==null&&(_=Math.min(p,Math.floor((a-1)/s)+1)),console.log(`[Optimize] Calculated target page range: ${M} - ${_}`)):console.log(`[Optimize] No floor range specified, loading all pages: 1 - ${p}`),u=M;for(let m=M;m<=_;m++)if(c=m,m===x){l(`处理 ${m}/${p}...`),console.log(`处理当前页 (${m})`);const I=Array.from($.querySelectorAll(':scope > div[id^="post_"]'));I.forEach(P=>P.dataset.s1Page=String(m)),await ae(I,m),I.forEach(P=>{P.querySelectorAll("img").forEach(C=>C.dataset.s1Page=String(m))}),console.log(`重新解析当前页 (${m})...`);const T=$.innerHTML,F=new DOMParser().parseFromString(`<body><div id="postlist">${T}</div></body>`,"text/html"),D=Array.from(F.querySelectorAll('#postlist > div[id^="post_"]'));D.forEach(P=>{P.dataset.s1Page=String(m),P.querySelectorAll("img").forEach(C=>C.dataset.s1Page=String(m))}),i.push(...D),console.log(`当前页 (${m}) 处理完成，添加 ${D.length} 帖子。`)}else{l(`加载 ${m}/${p}...`),console.log(`加载目标页 (${m})`);const I=`${location.protocol}//${location.host}/2b/thread-${O}-${m}-1.html`;let T;try{T=await Ze(I)}catch(C){console.error(`Page ${m}: 获取 HTML 失败!`,C);continue}const F=new DOMParser().parseFromString(T,"text/html"),D=F.querySelectorAll('#postlist > div[id^="post_"]'),P=[];if(D.forEach(C=>{C.dataset.s1Page=String(m),P.push(C)}),P.length===0){F.querySelectorAll('div[id^="post_"]').length>0?console.warn(`[Page ${m}] 找到了帖子，但不在 #postlist 下！`):console.warn(`[Page ${m}] 未找到任何帖子元素！跳过。`);continue}l(`解锁 ${m}/${p}...`),await ae(P,m),P.forEach(C=>{C.querySelectorAll("img").forEach(V=>V.dataset.s1Page=String(m))}),i.push(...P),console.log(`目标页 (${m}) 处理完成，添加 ${P.length} 帖子。`)}return console.log(`S1 Exporter: 所有页面加载和解锁完成，共收集到 ${i.length} 个帖子元素。`),{allPostElements:i,actualStartPage:u,actualEndPage:c}}async function Ze(s){try{const o=await fetch(s,{method:"GET",credentials:"same-origin"});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return await o.text()}catch(o){throw console.error(`S1 Exporter: 加载页面 ${s} 失败`,o),o}}async function ae(s,o){console.log(`S1 Exporter: 尝试解锁, 当前为 ${o} 页.`);const a=[],i=[".plhin","#messagetext"],u=["作者被禁止或删除 内容自动屏蔽","内容审核中，即将开放"];for(const f of s){let h=!1;for(let p=0;p<i.length;p++){const x=f.querySelector(i[p]);if(x&&x.innerText.includes(u[p])){h=!0;break}}h&&a.push(f)}if(a.length===0)return;console.log(`S1 Exporter: Page ${o} 检测到 ${a.length} 个被屏蔽的帖子...`);let c=!1;try{const f=await et(o),h=new Map(f.list.map(p=>[p.pid.toString(),p]));for(const p of a){const x=p.id.substring(5),$=h.get(x);if($){const M=p.querySelector(".pcb");M&&(M.innerHTML=A($))}else console.warn(`S1 Exporter: API 数据中未找到 Post ${x} (Page ${o}).`)}}catch(f){if(console.error(`S1 Exporter: 解锁 Page ${o} 时出错:`,f),f.message==="LOGIN_INVALID"&&!c)if(console.log("S1 Exporter: SID 失效，尝试重新登录..."),await q.storage.local.remove(t),await Se())R=(await q.storage.local.get(t))[t],console.log("S1 Exporter: 重新登录成功，重试解锁..."),c=!0,await ae(s,o);else throw new Error("重新登录失败，无法解锁内容");else throw f}}async function et(s,o=40){const a=new URL(e+"/thread/page"),i={sid:R,tid:O,pageNo:String(s),pageSize:String(o)},u=await fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:new URLSearchParams(i).toString()});if(!u.ok)throw new Error(`API /thread/page 请求失败: ${u.statusText}`);const c=await u.json();return new Promise((f,h)=>tt(c,f,h))}function tt(s,o,a){try{const i=typeof s=="string"?JSON.parse(s):s,u=i.code?.toString();if(!u){a(new Error("API_INVALID_RESPONSE"));return}if(u.startsWith("50")){console.warn("S1 Exporter: API 返回登录错误:",i.message),a(new Error("LOGIN_INVALID"));return}u!=="200"&&console.warn("S1 Exporter: API 返回非成功状态码:",u,i.message),i.data?o(i.data):(console.warn("S1 Exporter: API 响应成功但缺少 data 字段:",i),a(new Error("API_MISSING_DATA")))}catch(i){console.error("S1 Exporter: 解析 API 响应失败:",i,"原始响应:",s),a(new Error("API_PARSE_ERROR"))}}function Se(s={}){return new Promise(o=>{B=o,document.getElementById("login-dialog")?.remove(),document.body.insertAdjacentHTML("beforeend",L(s));const a=document.getElementById("login-dialog");if(!a)return console.error("无法创建登录对话框"),o(!1);const i=document.getElementById("questionId"),u=document.getElementById("answer-row"),c=document.getElementById("login-confirm"),f=document.getElementById("login-close"),h=document.getElementById("username"),p=document.getElementById("password"),x=document.getElementById("answer"),$=a.offsetHeight;i?.addEventListener("change",M=>{if(M.target.value==="0")a.style.height=`${$}px`,u.style.display="none";else if(!(u.style.display!=="none")){u.style.display="block";const I=a.offsetHeight+u.offsetHeight+20;a.style.height=`${I}px`}}),i?.dispatchEvent(new Event("change")),c?.addEventListener("click",()=>{nt(h.value,p.value,i.value,x.value)}),f?.addEventListener("click",()=>{a.remove(),B&&(B(!1),B=null)})})}async function nt(s,o,a,i){const u=new URLSearchParams;u.append("username",s),u.append("password",o),a!=="0"&&(u.append("questionid",a),u.append("answer",i));const c=document.querySelector("#login-dialog div:last-child");c&&(c.textContent="登录中...");try{const f=await fetch(e+"/user/login",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:u.toString()});if(!f.ok)throw new Error(`登录 API 请求失败: ${f.statusText}`);const h=await f.json(),p=h.code?.toString();p&&!p.startsWith("50")&&h.data?.sid?(await q.storage.local.set({[t]:h.data.sid}),document.getElementById("login-dialog")?.remove(),B&&(B(!0),B=null)):c&&(c.textContent=h.message||"登录失败，请检查信息。")}catch(f){console.error("Login API request failed:",f),c&&(c.textContent="登录请求失败，请检查网络。")}}function rt(s){if(!s)return null;if(s.includes("楼主"))return 1;const o=s.match(/^(\d+)/);return o?parseInt(o[1],10):null}function ot(s,o,a,i,u,c,f){let h=`# ${s}

**版块:** ${a}
**原帖:** <${o}>

`;const p=i,x=[];return W(`[parseAllPosts] 函数开始执行，选择器找到了 ${p.length} 个帖子。`),p.length===0?(console.error("[parseAllPosts] 错误：选择器没有找到任何帖子！"),W("[parseAllPosts] 错误：选择器没有找到任何帖子！","red"),{header:"[错误：未能解析任何帖子内容]",posts:[]}):(console.log(`S1 Exporter: 找到 ${p.length} 个帖子进行最终解析.`),p.forEach(($,M)=>{const _=$.querySelector('.pi strong a[id^="postnum"]'),m=_?_.innerText.trim():"N/A",I=rt(m);console.log(`[Debug] Post Index ${M}, Element ID ${$.id}, Floor Str: "${m}", Parsed Floor Num: ${I}`);let T=!1;if(I!==null?(u!==null&&I<u&&(T=!0),c!==null&&I>c&&(T=!0)):(u!==null||c!==null)&&(console.warn(`[Filter] Skipping post ${$.id} because floor "${m}" could not be parsed and a range was specified.`),T=!0),T)return;const F=$.querySelector(".pi .authi .xw1")?.innerText.trim()||"未知作者";let D=$.querySelector('.pi strong a[id^="postnum"]')?.innerText.trim()||"N/A";const P=$.querySelector('em[id^="authorposton"]')?.innerText.replace("发表于 ","").trim()||"未知时间";D==="楼主"?D="1# (楼主)":D&&D.includes("#")&&(D=D.replace(" #","#"));const C=$.querySelector('td[id^="postmessage_"]');let V="[内容无法加载或已被删除]";if(C){const d=C.cloneNode(!0);d.querySelector(".cronclosethread_getbox")?.remove();const w=d.querySelector("i.pstatus");if(w){const E=document.createElement("blockquote");E.innerText=w.innerText.trim(),w.parentNode.replaceChild(E,w)}const v=d.querySelectorAll("a[href]"),y=`${location.origin}/2b/`;v.forEach(E=>{let b=E.getAttribute("href");if(b&&!b.startsWith("http")&&!b.startsWith("//")&&!b.startsWith("#")&&!b.startsWith("javascript:"))try{E.setAttribute("href",new URL(b,y).href)}catch(S){console.warn(`无法将相对链接转换为绝对链接: ${b}`,S)}}),V=f.turndown(d)}let H=`

`;const j=$.querySelector('dl[id^="ratelog_"]');if(j){const d=j.querySelector("table.ratl");if(d){const w=d.querySelectorAll("tbody.ratl_l tr"),v=d.querySelector("tbody tr");let y="";if(v){const E=v.querySelector("th:nth-child(1) span")?.innerText||"?",b=v.querySelector("th:nth-child(2) i span")?.innerText||"?";y=` (参与人数 \`${E}\`, 总战斗力 \`${b}\`)`}w.length>0&&(H+=`> **评分**${y}:
`,w.forEach(E=>{const b=E.querySelector("td:nth-child(1) a:last-of-type"),S=b?b.innerText.trim():"匿名",U=E.querySelector("td:nth-child(2)")?.innerText.trim()||"?",G=E.querySelector("td:nth-child(3)")?.innerText.trim()||"";let $e=S;/^\d+\./.test(S)&&($e=S.replace(".","\\.")),H+=`> - ${$e} \`${U}\` ${G}
`}),H+=`>

`)}}x.push({floor:D,author:F,time:P,mdContent:V,rateContent:H})}),{header:h,posts:x})}function ye(s,o){const a=s.replace(/[\\/:*?"<>|]/g,"_")+".md",i=new Blob([o],{type:"text/markdown;charset=utf-8"}),u=URL.createObjectURL(i),c=document.createElement("a");c.href=u,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(u),console.log(`S1 Exporter: Markdown 文件 "${a}" 已触发下载.`)}async function be(){let s=null;try{const i=await q.runtime.sendMessage({type:"getTid"});i&&i.tid&&(s=i.tid.toString())}catch(i){console.warn("S1 Exporter: 无法从页面上下文 (window.tid) 获取TID:",i.message)}if(s)return console.log("S1 Exporter: 从 window.tid 获得 TID:",s),s;const o=window.location.pathname,a=new URLSearchParams(window.location.search);if(o.startsWith("/2b/thread-")){const i=o.split("-");i.length>=2&&(s=i[1])}else o.startsWith("/2b/forum.php")&&(s=a.get("tid"));return s?console.log("S1 Exporter: 从 URL 获得 TID:",s):console.warn("S1 Exporter: 未能从 URL 或全局变量中解析 TID."),s}function W(s,o="black"){console.log(s)}function it(s,o){if(o<=0)return[s];const a=[];for(let i=0;i<s.length;i+=o)a.push(s.slice(i,i+o));return a}q.runtime.onMessage.addListener((s,o,a)=>{if(s.type==="startExport"){if(window.s1ExportRunning)return console.warn("S1 Exporter: 导出已在进行中！"),a({status:"already_running"}),!0;const i=s.options||{startFloor:null,endFloor:null,postsPerPage:40,downloadImages:!0,linkFormat:"obsidian",emoteFormat:"obsidian",postsPerFile:null,startFile:null,endFile:null};return Xe(i),a({status:"started"}),!0}if(s.type==="getTidAndSettings")return(async()=>{try{const i=await be();let u=null;if(i){const c=`s1_exporter_settings_${i}`,f=localStorage.getItem(c);f&&(u=JSON.parse(f),console.log(`[ContentScript] Found settings for ${i}:`,u))}a({tid:i,settings:u})}catch(i){console.error("[ContentScript] Error getting TID or settings:",i),a({tid:null,settings:null,error:i.message})}})(),!0;if(s.type==="saveSettings"){const{tid:i,options:u}=s;if(i)try{const c=`s1_exporter_settings_${i}`;localStorage.setItem(c,JSON.stringify(u)),console.log(`[ContentScript] Settings for ${i} saved.`),a({status:"saved"})}catch(c){console.error("[ContentScript] Failed to save settings:",c),a({status:"error",error:c.message})}else console.warn("[ContentScript] Save request received without TID."),a({status:"error",error:"No TID provided"});return!0}return!0}),console.log("S1 Exporter (WXT, Modern, TS) 已加载。")}};function Y(e,...t){}const Ke={debug:(...e)=>Y(console.debug,...e),log:(...e)=>Y(console.log,...e),warn:(...e)=>Y(console.warn,...e),error:(...e)=>Y(console.error,...e)};class ie extends Event{constructor(t,n){super(ie.EVENT_NAME,{}),this.newUrl=t,this.oldUrl=n}static EVENT_NAME=se("wxt:locationchange")}function se(e){return`${q?.runtime?.id}:content:${e}`}function Ye(e){let t,n;return{run(){t==null&&(n=new URL(location.href),t=e.setInterval(()=>{let r=new URL(location.href);r.href!==n.href&&(window.dispatchEvent(new ie(r,n)),n=r)},1e3))}}}class Q{constructor(t,n){this.contentScriptName=t,this.options=n,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}static SCRIPT_STARTED_MESSAGE_TYPE=se("wxt:content-script-started");isTopFrame=window.self===window.top;abortController;locationWatcher=Ye(this);receivedMessageIds=new Set;get signal(){return this.abortController.signal}abort(t){return this.abortController.abort(t)}get isInvalid(){return q.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(t){return this.signal.addEventListener("abort",t),()=>this.signal.removeEventListener("abort",t)}block(){return new Promise(()=>{})}setInterval(t,n){const r=setInterval(()=>{this.isValid&&t()},n);return this.onInvalidated(()=>clearInterval(r)),r}setTimeout(t,n){const r=setTimeout(()=>{this.isValid&&t()},n);return this.onInvalidated(()=>clearTimeout(r)),r}requestAnimationFrame(t){const n=requestAnimationFrame((...r)=>{this.isValid&&t(...r)});return this.onInvalidated(()=>cancelAnimationFrame(n)),n}requestIdleCallback(t,n){const r=requestIdleCallback((...l)=>{this.signal.aborted||t(...l)},n);return this.onInvalidated(()=>cancelIdleCallback(r)),r}addEventListener(t,n,r,l){n==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),t.addEventListener?.(n.startsWith("wxt:")?se(n):n,r,{...l,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),Ke.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:Q.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(t){const n=t.data?.type===Q.SCRIPT_STARTED_MESSAGE_TYPE,r=t.data?.contentScriptName===this.contentScriptName,l=!this.receivedMessageIds.has(t.data?.messageId);return n&&r&&l}listenForNewerScripts(t){let n=!0;const r=l=>{if(this.verifyScriptStartedEvent(l)){this.receivedMessageIds.add(l.data.messageId);const g=n;if(n=!1,g&&t?.ignoreFirstEvent)return;this.notifyInvalidated()}};addEventListener("message",r),this.onInvalidated(()=>removeEventListener("message",r))}}function lt(){}function X(e,...t){}const Qe={debug:(...e)=>X(console.debug,...e),log:(...e)=>X(console.log,...e),warn:(...e)=>X(console.warn,...e),error:(...e)=>X(console.error,...e)};return(async()=>{try{const{main:e,...t}=ze,n=new Q("content",t);return await e(n)}catch(e){throw Qe.error('The content script "content" crashed on startup!',e),e}})()})();
content;